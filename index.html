<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Streak</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="container">
  <h2>The Streak Tracker</h2>

  <!-- AUTH -->
  <div id="auth-section">
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />

    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Log In</button>
    <button id="forgotBtn">Forgot Password?</button>

    <p id="authMessage"></p>
  </div>

  <!-- APP -->
  <div id="app-section" style="display:none;">
    <p id="streakDisplay">Loadingâ€¦</p>

    <div class="actions">
      <button id="markBtn">Mark Today</button>
      <button id="reflectBtn">Reflection</button>
      <button id="logoutBtn">Sign Out</button>
    </div>
  </div>
</div>

<!-- REFLECTION MODAL -->
<div id="reflectionModal" style="display:none;">
  <div class="modal-box">

    <div class="modal-header">
      <h3 id="reflectionDate">Date</h3>
      <button id="calendarBtn" class="calendar-btn">ðŸ“…</button>
    </div>

    <div id="calendarOverlay" style="display:none;">
      <div class="calendar-box">
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>

    <textarea
      id="reflectionText"
      placeholder="What do you want to write about today?"
      rows="6"
    ></textarea>

    <button id="saveReflectionBtn">Save</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyANFF4TkIpc3vB3_jwA5xK6rh4EryigVVI",
    authDomain: "the-streak2.firebaseapp.com",
    projectId: "the-streak2",
    storageBucket: "the-streak2.firebasestorage.app",
    messagingSenderId: "377658825110",
    appId: "1:377658825110:web:b7b3c7b407af8a9beda5b7"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const signupBtn = document.getElementById("signupBtn");
  const loginBtn = document.getElementById("loginBtn");
  const forgotBtn = document.getElementById("forgotBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const authMessage = document.getElementById("authMessage");
  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app-section");
  const streakDisplay = document.getElementById("streakDisplay");
  const markBtn = document.getElementById("markBtn");
  const reflectBtn = document.getElementById("reflectBtn");

  function friendlyAuthError(error) {
    switch (error.code) {
      case "auth/user-not-found": return "No account exists with this email.";
      case "auth/wrong-password": return "Incorrect password.";
      case "auth/email-already-in-use": return "Email already registered.";
      case "auth/invalid-email": return "Invalid email address.";
      case "auth/weak-password": return "Password must be at least 6 characters.";
      default: return "Authentication error.";
    }
  }

  signupBtn.onclick = async () => {
    try {
      await auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value);
    } catch (e) {
      authMessage.innerText = friendlyAuthError(e);
    }
  };

  loginBtn.onclick = async () => {
    try {
      await auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value);
    } catch (e) {
      authMessage.innerText = friendlyAuthError(e);
    }
  };

  forgotBtn.onclick = async () => {
    if (!emailInput.value) return;
    await auth.sendPasswordResetEmail(emailInput.value);
    authMessage.innerText = "Password reset email sent.";
  };

  logoutBtn.onclick = () => auth.signOut();

  auth.onAuthStateChanged(async user => {
    if (!user) {
      authSection.style.display = "block";
      appSection.style.display = "none";
      return;
    }

    authSection.style.display = "none";
    appSection.style.display = "block";

    const ref = db.collection("users").doc(user.uid);
    if (!(await ref.get()).exists) {
      await ref.set({ streak: 0, lastCheck: null });
    }

    loadStreak(user.uid);
  });

  async function loadStreak(uid) {
    const snap = await db.collection("users").doc(uid).get();
    streakDisplay.innerText = "Current streak: " + snap.data().streak + " days";
  }

  markBtn.onclick = async () => {
    const ref = db.collection("users").doc(auth.currentUser.uid);
    const data = (await ref.get()).data();

    const today = new Date().toDateString();
    if (data.lastCheck === today) return alert("Already marked today");

    const yesterday = new Date(Date.now() - 86400000).toDateString();
    const newStreak =
      data.lastCheck === yesterday || data.lastCheck === null ? data.streak + 1 : 1;

    await ref.update({ streak: newStreak, lastCheck: today });
    streakDisplay.innerText = "Current streak: " + newStreak + " days";
  };
</script>

<script>
  let activeDateKey = "";
  const modal = document.getElementById("reflectionModal");
  const saveBtn = document.getElementById("saveReflectionBtn");
  const reflectionText = document.getElementById("reflectionText");
  const reflectionDate = document.getElementById("reflectionDate");
  const calendarBtn = document.getElementById("calendarBtn");
  const calendarOverlay = document.getElementById("calendarOverlay");
  const calendarGrid = document.getElementById("calendarGrid");

  function dateKey(d) {
    return d.toISOString().slice(0, 10);
  }

  function todayKey() {
    const d = new Date();
    d.setHours(0,0,0,0);
    return dateKey(d);
  }

  reflectBtn.onclick = () => openReflection(todayKey());

  function openReflection(key) {
    activeDateKey = key;
    reflectionDate.innerText = "Date: " + key;
    reflectionText.value = localStorage.getItem("reflection-" + key) || "";
    modal.style.display = "flex";
  }

  saveBtn.onclick = () => {
    localStorage.setItem("reflection-" + activeDateKey, reflectionText.value);
    modal.style.display = "none";
  };

  calendarBtn.onclick = async () => {
    calendarGrid.innerHTML = "";
    calendarOverlay.style.display = "flex";

    const today = new Date();
    const days = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();

    for (let d = 1; d <= days; d++) {
      const date = new Date(today.getFullYear(), today.getMonth(), d);
      const cell = document.createElement("div");
      cell.className = "calendar-day active";
      cell.innerText = d;
      cell.onclick = () => {
        openReflection(dateKey(date));
        calendarOverlay.style.display = "none";
      };
      calendarGrid.appendChild(cell);
    }
  };
</script>

</body>
</html>

