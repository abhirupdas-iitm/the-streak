<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Streak</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="container">
  <h2>The Streak Tracker</h2>

  <div id="auth-section">
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Log In</button>
    <button id="forgotBtn">Forgot Password?</button>
    <p id="authMessage"></p>
  </div>

  <div id="app-section" style="display:none;">
    <p id="streakDisplay">Loadingâ€¦</p>
    <div class="actions">
      <button id="markBtn">Mark Today</button>
      <button id="reflectBtn">Reflection</button>
      <button id="calendarBtn">ðŸ“…</button>
      <button id="logoutBtn">Sign Out</button>
    </div>
  </div>
</div>

<div id="reflectionModal" class="overlay" style="display:none;">
  <div class="modal-box">
    <textarea id="reflectionText" rows="6"
      placeholder="What do you want to write today?"></textarea>
    <button id="saveReflectionBtn">Save</button>
  </div>
</div>

<div id="calendarOverlay" class="overlay" style="display:none;">
  <div class="calendar-box">
    <div class="calendar-header">
      <button id="prevMonthBtn">â—€</button>

      <div class="calendar-selectors">
        <select id="monthSelect"></select>
        <select id="yearSelect"></select>
      </div>

      <button id="nextMonthBtn">â–¶</button>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyANFF4TkIpc3vB3_jwA5xK6rh4EryigVVI",
  authDomain: "the-streak2.firebaseapp.com",
  projectId: "the-streak2",
  storageBucket: "the-streak2.firebasestorage.app",
  messagingSenderId: "377658825110",
  appId: "1:377658825110:web:b7b3c7b407af8a9beda5b7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const authSection = document.getElementById("auth-section");
const appSection = document.getElementById("app-section");
const streakDisplay = document.getElementById("streakDisplay");

const markBtn = document.getElementById("markBtn");
const reflectBtn = document.getElementById("reflectBtn");
const calendarBtn = document.getElementById("calendarBtn");
const logoutBtn = document.getElementById("logoutBtn");

const reflectionModal = document.getElementById("reflectionModal");
const calendarOverlay = document.getElementById("calendarOverlay");
const reflectionText = document.getElementById("reflectionText");
const saveBtn = document.getElementById("saveReflectionBtn");

const calendarGrid = document.getElementById("calendarGrid");
const prevMonthBtn = document.getElementById("prevMonthBtn");
const nextMonthBtn = document.getElementById("nextMonthBtn");
const monthSelect = document.getElementById("monthSelect");
const yearSelect = document.getElementById("yearSelect");

function todayDate() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d;
}
function dateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

let calendarYear, calendarMonth;
let activeDate = null;

const MONTHS = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

auth.onAuthStateChanged(async user => {
  if (!user) {
    authSection.style.display = "block";
    appSection.style.display = "none";
    return;
  }
  authSection.style.display = "none";
  appSection.style.display = "block";

  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();
  if (!snap.exists) await ref.set({ streak: 0, lastCheck: null });

  streakDisplay.innerText = `Current streak: ${snap.data().streak} days`;
});

markBtn.onclick = async () => {
  const ref = db.collection("users").doc(auth.currentUser.uid);
  const data = (await ref.get()).data();

  const todayStr = new Date().toDateString();
  if (data.lastCheck === todayStr) {
    alert("Already marked for today!");
    return;
  }

  const yesterdayStr =
    new Date(Date.now() - 86400000).toDateString();

  const streak =
    data.lastCheck === yesterdayStr || data.lastCheck === null
      ? data.streak + 1 : 1;

  await ref.update({ streak, lastCheck: todayStr });
  streakDisplay.innerText = `Current streak: ${streak} days`;
};

reflectBtn.onclick = () => {
  const today = todayDate();
  calendarYear = today.getFullYear();
  calendarMonth = today.getMonth();
  openReflection(today);
};

function openReflection(date) {
  activeDate = date;
  reflectionText.value =
    localStorage.getItem("reflection-" + dateKey(date)) || "";

  const isToday = dateKey(date) === dateKey(todayDate());
  reflectionText.disabled = !isToday;
  saveBtn.style.display = isToday ? "block" : "none";

  reflectionModal.style.display = "flex";
}

saveBtn.onclick = () => {
  localStorage.setItem(
    "reflection-" + dateKey(activeDate),
    reflectionText.value
  );
  closeOverlays();
};

calendarBtn.onclick = async () => {
  const today = todayDate();
  calendarYear = today.getFullYear();
  calendarMonth = today.getMonth();
  initSelectors();
  await renderCalendar();
  calendarOverlay.style.display = "flex";
};

function initSelectors() {
  monthSelect.innerHTML = "";
  yearSelect.innerHTML = "";

  MONTHS.forEach((m, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = m;
    monthSelect.appendChild(opt);
  });

  const currentYear = todayDate().getFullYear();
  for (let y = currentYear; y >= currentYear - 15; y--) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  }

  syncSelectors();
}

/* âœ… FIXED: now top-level */
function syncSelectors() {
  monthSelect.value = calendarMonth;
  yearSelect.value = calendarYear;
}

monthSelect.onchange = () => {
  calendarMonth = Number(monthSelect.value);
  renderCalendar();
};

yearSelect.onchange = () => {
  calendarYear = Number(yearSelect.value);
  renderCalendar();
};

prevMonthBtn.onclick = () => {
  calendarMonth--;
  if (calendarMonth < 0) {
    calendarMonth = 11;
    calendarYear--;
  }
  syncSelectors();
  renderCalendar();
};

nextMonthBtn.onclick = () => {
  calendarMonth++;
  if (calendarMonth > 11) {
    calendarMonth = 0;
    calendarYear++;
  }
  syncSelectors();
  renderCalendar();
};

async function renderCalendar() {
  calendarGrid.innerHTML = "";

  const snap = await db.collection("users")
    .doc(auth.currentUser.uid).get();
  const streak = snap.data().streak;

  const today = todayDate();
  const start = new Date(today);
  start.setDate(today.getDate() - streak + 1);

  const daysInMonth =
    new Date(calendarYear, calendarMonth + 1, 0).getDate();

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(calendarYear, calendarMonth, d);
    date.setHours(0,0,0,0);

    const cell = document.createElement("div");
    cell.className = "calendar-day";
    cell.innerText = d;

    if (date < start || date > today) {
      cell.classList.add("past");
    } else {
      cell.classList.add("active");
      cell.onclick = () => {
        calendarOverlay.style.display = "none";
        openReflection(date);
      };
    }
    calendarGrid.appendChild(cell);
  }
}

function closeOverlays() {
  reflectionModal.style.display = "none";
  calendarOverlay.style.display = "none";
}

document.querySelectorAll(".overlay").forEach(ov => {
  ov.addEventListener("click", e => {
    if (e.target === ov) closeOverlays();
  });
});

document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeOverlays();
});

logoutBtn.onclick = () => auth.signOut();
</script>

</body>
</html>

