<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Streak</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="container">
  <h2>The Streak Tracker</h2>

  <!-- AUTH -->
  <div id="auth-section">
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Log In</button>
    <p id="authMessage"></p>
  </div>

  <!-- APP -->
  <div id="app-section" style="display:none;">
    <p id="streakDisplay">Loadingâ€¦</p>

    <div class="actions">
      <button id="markBtn">Mark Today</button>
      <button id="reflectBtn">Reflection</button>
    </div>
  </div>
</div>

<!-- REFLECTION MODAL -->
<div id="reflectionModal" style="display:none;">
  <div class="modal-box">

    <div class="modal-header">
      <h3 id="reflectionDate">Date</h3>
      <button id="calendarBtn" class="calendar-btn" title="Open calendar">ðŸ“…</button>
    </div>

    <!-- CALENDAR -->
    <div id="calendarOverlay" style="display:none;">
      <div class="calendar-box">
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>

    <textarea
      id="reflectionText"
      placeholder="What do you want to write about today?"
      rows="6"
    ></textarea>

    <button id="saveReflectionBtn">Save</button>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyANFF4TkIpc3vB3_jwA5xK6rh4EryigVVI",
    authDomain: "the-streak2.firebaseapp.com",
    projectId: "the-streak2",
    storageBucket: "the-streak2.firebasestorage.app",
    messagingSenderId: "377658825110",
    appId: "1:377658825110:web:b7b3c7b407af8a9beda5b7"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const signupBtn = document.getElementById("signupBtn");
  const loginBtn = document.getElementById("loginBtn");
  const authMessage = document.getElementById("authMessage");
  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app-section");
  const streakDisplay = document.getElementById("streakDisplay");
  const markBtn = document.getElementById("markBtn");
</script>

<script>
  signupBtn.onclick = async () => {
    try {
      await auth.createUserWithEmailAndPassword(
        emailInput.value,
        passwordInput.value
      );
      authMessage.innerText = "Signup successful!";
    } catch (e) {
      authMessage.innerText = e.message;
    }
  };

  loginBtn.onclick = async () => {
    try {
      await auth.signInWithEmailAndPassword(
        emailInput.value,
        passwordInput.value
      );
      authMessage.innerText = "Login successful!";
    } catch (e) {
      authMessage.innerText = e.message;
    }
  };

  auth.onAuthStateChanged(user => {
    if (!user) return;

    authSection.style.display = "none";
    appSection.style.display = "block";
    loadStreak(user.uid);
  });
</script>

<script>
  async function loadStreak(uid) {
    const ref = db.collection("users").doc(uid);
    const snap = await ref.get();

    if (!snap.exists) {
      await ref.set({ streak: 0, lastCheck: null });
      streakDisplay.innerText = "Current streak: 0 days";
      return;
    }

    streakDisplay.innerText =
      "Current streak: " + snap.data().streak + " days";
  }

  markBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;

    const ref = db.collection("users").doc(user.uid);
    const snap = await ref.get();
    const data = snap.data();

    const today = new Date().toDateString();
    if (data.lastCheck === today) {
      alert("Already marked today!");
      return;
    }

    const yesterday = new Date(Date.now() - 86400000).toDateString();
    const newStreak =
      data.lastCheck === yesterday || data.lastCheck === null
        ? data.streak + 1
        : 1;

    await ref.update({
      streak: newStreak,
      lastCheck: today
    });

    streakDisplay.innerText =
      "Current streak: " + newStreak + " days";
  };
</script>

<script>
  let originalReflectionText = "";
  let hasUnsavedChanges = false;
  let activeDateKey = "";

  const reflectBtn = document.getElementById("reflectBtn");
  const modal = document.getElementById("reflectionModal");
  const saveBtn = document.getElementById("saveReflectionBtn");
  const reflectionText = document.getElementById("reflectionText");
  const reflectionDate = document.getElementById("reflectionDate");
  const calendarBtn = document.getElementById("calendarBtn");
  const calendarOverlay = document.getElementById("calendarOverlay");
  const calendarGrid = document.getElementById("calendarGrid");

  function getTodayKey() {
    return new Date().toISOString().split("T")[0];
  }

  reflectionText.addEventListener("input", () => {
    hasUnsavedChanges = reflectionText.value !== originalReflectionText;
  });

  function openReflection(dateKey = getTodayKey()) {
    activeDateKey = dateKey;
    reflectionDate.innerText = "Date: " + dateKey;

    const saved = localStorage.getItem("reflection-" + dateKey);
    reflectionText.value = saved || "";

    originalReflectionText = reflectionText.value;
    hasUnsavedChanges = false;

    modal.style.display = "flex";
  }

  function saveReflection() {
    localStorage.setItem(
      "reflection-" + activeDateKey,
      reflectionText.value
    );

    originalReflectionText = reflectionText.value;
    hasUnsavedChanges = false;
    modal.style.display = "none";
  }

  function renderCalendar() {
    calendarGrid.innerHTML = "";

    const today = new Date();
    const year = today.getFullYear();
    const start = new Date(year, 0, 1);
    const end = new Date(year, today.getMonth(), today.getDate());

    let d = new Date(start);

    while (d <= end) {
      const key = d.toISOString().split("T")[0];
      const btn = document.createElement("button");
      btn.innerText = d.getDate();
      btn.className = "calendar-day";

      if (key < activeDateKey) btn.classList.add("past");
      if (key === activeDateKey) btn.classList.add("selected");

      btn.onclick = () => {
        openReflection(key);
        calendarOverlay.style.display = "none";
      };

      calendarGrid.appendChild(btn);
      d.setDate(d.getDate() + 1);
    }
  }

  reflectBtn.onclick = () => openReflection();
  saveBtn.onclick = saveReflection;

  calendarBtn.onclick = () => {
    renderCalendar();
    calendarOverlay.style.display = "block";
  };

  modal.addEventListener("click", (e) => {
    if (e.target !== modal) return;

    if (!hasUnsavedChanges) {
      modal.style.display = "none";
      return;
    }

    if (confirm("You have unsaved changes. Close without saving?")) {
      hasUnsavedChanges = false;
      modal.style.display = "none";
    }
  });
</script>

</body>
</html>
