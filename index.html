<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Streak</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="container">
  <h2>The Streak Tracker</h2>

  <!-- AUTH -->
  <div id="auth-section">
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Log In</button>
    <button id="forgotBtn">Forgot Password?</button>
    <p id="authMessage"></p>
  </div>

  <!-- APP -->
  <div id="app-section" style="display:none;">
    <p id="streakDisplay">Loadingâ€¦</p>
    <div class="actions">
      <button id="markBtn">Mark Today</button>
      <button id="reflectBtn">Reflection</button>
      <button id="calendarBtn">ðŸ“…</button>
      <button id="logoutBtn">Sign Out</button>
    </div>
  </div>
</div>

<!-- REFLECTION MODAL (TEXT ONLY) -->
<div id="reflectionModal" style="display:none;">
  <div class="modal-box">
    <textarea
      id="reflectionText"
      placeholder="What do you want to write about today?"
      rows="6"
    ></textarea>
    <button id="saveReflectionBtn">Save</button>
  </div>
</div>

<!-- CALENDAR OVERLAY -->
<div id="calendarOverlay" style="display:none;">
  <div class="calendar-box">
    <div class="calendar-header">
      <button id="prevMonthBtn">â—€</button>
      <h3 id="calendarTitle">Month</h3>
      <button id="nextMonthBtn">â–¶</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ---------- AUTH + STREAK ---------- */

const firebaseConfig = {
  apiKey: "AIzaSyANFF4TkIpc3vB3_jwA5xK6rh4EryigVVI",
  authDomain: "the-streak2.firebaseapp.com",
  projectId: "the-streak2",
  storageBucket: "the-streak2.firebasestorage.app",
  messagingSenderId: "377658825110",
  appId: "1:377658825110:web:b7b3c7b407af8a9beda5b7"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const signupBtn = document.getElementById("signupBtn");
const loginBtn = document.getElementById("loginBtn");
const forgotBtn = document.getElementById("forgotBtn");
const logoutBtn = document.getElementById("logoutBtn");

const authSection = document.getElementById("auth-section");
const appSection = document.getElementById("app-section");
const streakDisplay = document.getElementById("streakDisplay");
const markBtn = document.getElementById("markBtn");
const reflectBtn = document.getElementById("reflectBtn");
const calendarBtn = document.getElementById("calendarBtn");

signupBtn.onclick = () =>
  auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value);

loginBtn.onclick = () =>
  auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value);

forgotBtn.onclick = () =>
  auth.sendPasswordResetEmail(emailInput.value);

logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(async user => {
  if (!user) {
    authSection.style.display = "block";
    appSection.style.display = "none";
    return;
  }

  authSection.style.display = "none";
  appSection.style.display = "block";

  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();
  if (!snap.exists) await ref.set({ streak: 0, lastCheck: null });

  loadStreak(user.uid);
});

async function loadStreak(uid) {
  const snap = await db.collection("users").doc(uid).get();
  streakDisplay.innerText = `Current streak: ${snap.data().streak} days`;
}

markBtn.onclick = async () => {
  const ref = db.collection("users").doc(auth.currentUser.uid);
  const data = (await ref.get()).data();

  const todayStr = new Date().toDateString();
  if (data.lastCheck === todayStr) return alert("Already marked today");

  const yesterdayStr =
    new Date(Date.now() - 86400000).toDateString();

  const newStreak =
    data.lastCheck === yesterdayStr || data.lastCheck === null
      ? data.streak + 1
      : 1;

  await ref.update({ streak: newStreak, lastCheck: todayStr });
  streakDisplay.innerText = `Current streak: ${newStreak} days`;
};
</script>

<script>
/* ---------- REFLECTION + CALENDAR ---------- */

const reflectionModal = document.getElementById("reflectionModal");
const reflectionText = document.getElementById("reflectionText");
const saveBtn = document.getElementById("saveReflectionBtn");

const calendarOverlay = document.getElementById("calendarOverlay");
const calendarGrid = document.getElementById("calendarGrid");
const calendarTitle = document.getElementById("calendarTitle");
const prevMonthBtn = document.getElementById("prevMonthBtn");
const nextMonthBtn = document.getElementById("nextMonthBtn");

let calendarYear, calendarMonth;
let activeDate = null;

function todayDate() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d;
}

function dateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

/* Reflection button â†’ open TODAY */
reflectBtn.onclick = () => {
  const today = todayDate();
  calendarYear = today.getFullYear();
  calendarMonth = today.getMonth();
  openReflection(today);
};

function openReflection(date) {
  activeDate = date;
  reflectionText.value =
    localStorage.getItem("reflection-" + dateKey(date)) || "";

  const isToday = dateKey(date) === dateKey(todayDate());
  reflectionText.disabled = !isToday;
  saveBtn.style.display = isToday ? "block" : "none";

  reflectionModal.style.display = "flex";
}

saveBtn.onclick = () => {
  localStorage.setItem(
    "reflection-" + dateKey(activeDate),
    reflectionText.value
  );
  reflectionModal.style.display = "none";
};

/* Calendar button */
calendarBtn.onclick = () => {
  renderCalendar();
  calendarOverlay.style.display = "flex";
};

prevMonthBtn.onclick = () => {
  calendarMonth--;
  if (calendarMonth < 0) {
    calendarMonth = 11;
    calendarYear--;
  }
  renderCalendar();
};

nextMonthBtn.onclick = () => {
  calendarMonth++;
  if (calendarMonth > 11) {
    calendarMonth = 0;
    calendarYear++;
  }
  renderCalendar();
};

async function renderCalendar() {
  calendarGrid.innerHTML = "";

  const snap = await db.collection("users")
    .doc(auth.currentUser.uid).get();
  const streak = snap.data().streak;

  const today = todayDate();
  const start = new Date(today);
  start.setDate(today.getDate() - streak + 1);

  calendarTitle.innerText =
    new Date(calendarYear, calendarMonth)
      .toLocaleString("default", { month: "long", year: "numeric" });

  const daysInMonth =
    new Date(calendarYear, calendarMonth + 1, 0).getDate();

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(calendarYear, calendarMonth, d);
    date.setHours(0,0,0,0);

    const cell = document.createElement("div");
    cell.className = "calendar-day";
    cell.innerText = d;

    if (date < start || date > today) {
      cell.classList.add("past");
    } else {
      cell.classList.add("active");
      cell.onclick = () => {
        calendarOverlay.style.display = "none";
        openReflection(date);
      };
    }

    calendarGrid.appendChild(cell);
  }
}
</script>

</body>
</html>

