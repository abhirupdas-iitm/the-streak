<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Streak</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="container">
  <h2>The Streak Tracker</h2>

  <!-- AUTH -->
  <div id="auth-section">
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />

    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Log In</button>
    <button id="forgotBtn">Forgot Password?</button>

    <p id="authMessage"></p>
  </div>

  <!-- APP -->
  <div id="app-section" style="display:none;">
    <p id="streakDisplay">Loadingâ€¦</p>

    <div class="actions">
      <button id="markBtn">Mark Today</button>
      <button id="reflectBtn">Reflection</button>
      <button id="logoutBtn">Sign Out</button>
    </div>
  </div>
</div>

<!-- REFLECTION MODAL -->
<div id="reflectionModal" style="display:none;">
  <div class="modal-box">

    <div class="modal-header">
      <h3 id="reflectionDate">Date</h3>
      <button id="calendarBtn" class="calendar-btn">ðŸ“…</button>
    </div>

    <div id="calendarOverlay" style="display:none;">
      <div class="calendar-box">
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>

    <textarea
      id="reflectionText"
      placeholder="What do you want to write about today?"
      rows="6"
    ></textarea>

    <button id="saveReflectionBtn">Save</button>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyANFF4TkIpc3vB3_jwA5xK6rh4EryigVVI",
    authDomain: "the-streak2.firebaseapp.com",
    projectId: "the-streak2",
    storageBucket: "the-streak2.firebasestorage.app",
    messagingSenderId: "377658825110",
    appId: "1:377658825110:web:b7b3c7b407af8a9beda5b7"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const signupBtn = document.getElementById("signupBtn");
  const loginBtn = document.getElementById("loginBtn");
  const forgotBtn = document.getElementById("forgotBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const authMessage = document.getElementById("authMessage");
  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app-section");
  const streakDisplay = document.getElementById("streakDisplay");
  const markBtn = document.getElementById("markBtn");

  function friendlyAuthError(error) {
    switch (error.code) {
      case "auth/user-not-found":
        return "No account exists with this email.";
      case "auth/wrong-password":
        return "Incorrect password. Please try again.";
      case "auth/email-already-in-use":
        return "This email is already registered. Please log in.";
      case "auth/invalid-email":
        return "Please enter a valid email address.";
      case "auth/weak-password":
        return "Password should be at least 6 characters.";
      default:
        return "Authentication error. Please try again.";
    }
  }
</script>

<script>
  signupBtn.onclick = async () => {
    try {
      await auth.createUserWithEmailAndPassword(
        emailInput.value,
        passwordInput.value
      );
      authMessage.innerText = "Signup successful!";
    } catch (e) {
      authMessage.innerText = friendlyAuthError(e);
    }
  };

  loginBtn.onclick = async () => {
    try {
      await auth.signInWithEmailAndPassword(
        emailInput.value,
        passwordInput.value
      );
      authMessage.innerText = "Login successful!";
    } catch (e) {
      authMessage.innerText = friendlyAuthError(e);
    }
  };

  forgotBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if (!email) {
      authMessage.innerText = "Please enter your email first.";
      return;
    }
    try {
      await auth.sendPasswordResetEmail(email);
      authMessage.innerText =
        "Password reset email sent. Check your inbox.";
    } catch (e) {
      authMessage.innerText = friendlyAuthError(e);
    }
  };

  logoutBtn.onclick = async () => {
    await auth.signOut();
  };

  auth.onAuthStateChanged(async user => {
    if (!user) {
      authSection.style.display = "block";
      appSection.style.display = "none";
      authMessage.innerText = "";
      return;
    }

    authSection.style.display = "none";
    appSection.style.display = "block";

    const ref = db.collection("users").doc(user.uid);
    const snap = await ref.get();

    if (!snap.exists) {
      await ref.set({ streak: 0, lastCheck: null });
    }

    loadStreak(user.uid);
  });
</script>

<script>
  async function loadStreak(uid) {
    const snap = await db.collection("users").doc(uid).get();
    streakDisplay.innerText =
      "Current streak: " + snap.data().streak + " days";
  }

  markBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;

    const ref = db.collection("users").doc(user.uid);
    const snap = await ref.get();
    const data = snap.data();

    const todayStr = new Date().toDateString();
    if (data.lastCheck === todayStr) {
      alert("Already marked today!");
      return;
    }

    const yesterdayStr =
      new Date(Date.now() - 86400000).toDateString();

    const newStreak =
      data.lastCheck === yesterdayStr || data.lastCheck === null
        ? data.streak + 1
        : 1;

    await ref.update({
      streak: newStreak,
      lastCheck: todayStr
    });

    streakDisplay.innerText =
      "Current streak: " + newStreak + " days";
  };
</script>

</body>
</html>
